name: Auto Tag, Release, and Build Docker Image

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
    inputs:
      release_version:
        description: "Manually specify next release version (leave empty for auto)"
        required: false
        default: ""

jobs:
  tag-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_tag: ${{ steps.bump_version.outputs.new_tag }}
      latest_tag: ${{ steps.bump_version.outputs.latest_tag }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git User
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"

      - name: Fetch All Tags
        run: git fetch --tags --force

      - name: Determine Next Release Version
        id: bump_version
        run: |
          manual_version="${{ github.event.inputs.release_version }}"
          if [[ -n "$manual_version" ]]; then
            new_version="$manual_version"
          else
            latest_tag=$(git tag --sort=-v:refname | head -n 1)
            if [[ -z "$latest_tag" ]]; then
              latest_tag="v0.0.0"
            fi
            version=${latest_tag#v}
            version=${version#dev-v}
            IFS='.' read -r -a parts <<< "$version"

            while true; do
              parts[2]=$((parts[2] + 1))
              new_version="${parts[0]}.${parts[1]}.${parts[2]}"

              if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
                candidate_tag="dev-v$new_version"
              else
                candidate_tag="v$new_version"
              fi

              if ! git rev-parse "$candidate_tag" >/dev/null 2>&1; then
                break
              fi
            done
          fi

          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            new_tag="dev-v$new_version"
            latest_tag="dev-latest"
          else
            new_tag="v$new_version"
            latest_tag="latest"
          fi

          echo "new_tag=$new_tag" >> $GITHUB_ENV
          echo "latest_tag=$latest_tag" >> $GITHUB_ENV
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT

      - name: Create and Push Git Tag
        run: |
          git tag -a ${{ env.new_tag }} ${{ github.sha }} -m "Release ${{ env.new_tag }}"
          git push origin ${{ env.new_tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.new_tag }}
          name: Release ${{ env.new_tag }}
          draft: false
          prerelease: false

  build-and-push-ghcr:
    needs: tag-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_name: ${{ steps.get_image_name.outputs.IMAGE_NAME }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Image name
        id: get_image_name
        run: |
          echo "IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/${{ vars.GHCR_IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]' >> "$GITHUB_OUTPUT"

      - name: Remove Previous `latest` or `dev-latest` Tag
        run: |
          docker image rm -f ${{ steps.get_image_name.outputs.IMAGE_NAME }}:${{ needs.tag-and-release.outputs.latest_tag }} || true

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          no-cache: true
          tags: |
            ${{ steps.get_image_name.outputs.IMAGE_NAME }}:${{ needs.tag-and-release.outputs.new_tag }}
            ${{ steps.get_image_name.outputs.IMAGE_NAME }}:${{ needs.tag-and-release.outputs.latest_tag }}

